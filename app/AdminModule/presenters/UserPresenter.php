<?phpnamespace App\AdminModule\Presenters;use DbTable;/** * Prezenter pre spravu uzivatela. *  * Posledna zmena(last change): 03.12.2015 * @actions default, add, edit[$id] * *	Modul: ADMIN * * @author Ing. Peter VOJTECH ml. <petak23@gmail.com> * @copyright  Copyright (c) 2012 - 2015 Ing. Peter VOJTECH ml. * @license * @link       http://petak23.echo-msz.eu * @version 1.0.6 */class UserPresenter extends \App\AdminModule\Presenters\BasePresenter {  /**    * @inject   * @var DbTable\Users */	public $users;    /** @var Forms\User\AddUserFormFactory @inject*/	public $addUserForm;  /** @var Forms\User\EditUserFormFactory @inject*/	public $editUserForm;  /** @var Nette\Database\Table\ActiveRow Udaje konkretneho clena*/  private $clen;  /** @var array Nastavenie zobrazovania volitelnych poloziek */  private $user_view_fields;  protected function startup() {    parent::startup();    $this->user_view_fields = $this->nastavenie['user_view_fields'];	}    /** Render pre default-nu akciu */  public function renderDefault() {		$this->template->poc_pr_udaje = $this->user_profiles->getPocetPr();		//Zistenie max a sum prihlásenia		$this->template->clenovia = $this->user_profiles->findAll();    $this->template->h2 = 'Výpis všetkých členov';    $this->template->user_view_fields = $this->user_view_fields;	}  /** Akcia pridania uzivatela */  public function actionAdd() {    $this->template->h2 = 'Pridanie nového užívateľa';	}  /** Akcia pre editaciu clena   * @param int $id Id editovaneho clena   */  public function actionEdit($id) {    if (($this->clen = $this->user_profiles->find($id)) === FALSE) {			$this->setView('notFound');		} else {      $this->template->h2 = 'Editácia profilu';      $this["editUserForm"]->setDefaults($this->clen);      $this["editUserForm"]->setDefaults([        'created'   => $this->clen->created < '2000-01-02' ? StrFTime("%Y-%m-%d %H:%M:%S", Time()) : $this->clen->created,        'modified'  => StrFTime("%Y-%m-%d %H:%M:%S", Time()),        'username'  => $this->clen->user->username,        'email'  => $this->clen->user->email,          ]);    }	}    /** Formular pre pridanie uzivatela.	 * @return Nette\Application\UI\Form	 */	protected function createComponentAddUserForm() {    $form = $this->addUserForm->create($this->users, $this->urovneReg, $this->user_view_fields["pohl"]);    $form['uloz']->onClick[] = [$this, 'addUserFormSubmitted'];    $form['cancel']->onClick[] = [$this, 'formCancelled'];		return $this->_vzhladForm($form);	}    /** Spracovanie formulara pre pridanie uzivatela   * @param Nette\Forms\Controls\SubmitButton $button Data formulara   */  public function addUserFormSubmitted($button) {		// Inicializacia    $values = $button->getForm()->getValues(); 	//Nacitanie hodnot formulara    $hasser = $this->user->getAuthenticator(); //Ziskanie objektu pre vytvaranie hash hesla a iných    $hasser->PasswordHash(8,FALSE);            //Nastavenie        //Uloz info do tabulky users    $uloz_users = $this->users->uloz([ //Ulozenie do tabulky users      'username'  => $values->username,      'password'  => $hasser->HashPassword($values->heslo),      'email'     => $values->email,      'activated' => 1,    ]);    if (!empty($uloz_users['id'])) { //Ulozenie v poriadku      $uloz_user_profiles = $this->user_profiles->uloz([ //Ulozenie do tabulky user_profiles        'id_users'  => $uloz_users['id'], //vloz id ulozeneho clena        'meno'      => $values->meno,        'priezvisko'=> $values->priezvisko,        'id_registracia'  => $values->id_registracia,        'pohl'      => isset($values->pohl) ? $values->pohl : 'Z',        'modified'  => StrFTime("%Y-%m-%d %H:%M:%S", Time()),        'created'   => StrFTime("%Y-%m-%d %H:%M:%S", Time()),      ]);    }    if (!empty($uloz_user_profiles['id'])) { //Ulozenie v poriadku      $this->flashRedirect('User:', 'Nový užívateľ uložený v poriadku!', 'success');    } else { $this->flashMessage('Uloženie sa nepodarilo!', 'danger');}	//Ulozenie sa nepodarilo  }  /**   * Edit user form component factory. Tovarnicka na formular pre editaciu clena   * @return \Nette\Application\UI\Form   */	protected function createComponentEditUserForm() {    $form = $this->editUserForm->create($this->users, $this->id_reg, $this->urovneReg, $this->user_view_fields);    $form['uloz']->onClick[] = [$this, 'editUserFormSubmitted'];    $form['cancel']->onClick[] = [$this, 'formCancelled'];		return $this->_vzhladForm($form);	}  /** Funkcia pre ulozenie editovanych udajov o uzivatelovy   * @param Nette\Forms\Controls\SubmitButton $button Data formulara   */  public function editUserFormSubmitted($button) {		$values = $button->getForm()->getValues(); 	//Nacitanie hodnot formulara    $id_user_profiles = (int)$values->id;    $id_users = (int)$values->id_users;    unset($values->id, $values->id_users);        //Uloz info do tabulky users    $uloz_users = $this->users->uloz([      'username'  => $values->username,      'email'     => $values->email,    ], $id_users);    if (!empty($uloz_users['id'])) {      unset($values->username, $values->email);      $uloz = $this->user_profiles->uloz($values, $id_user_profiles);    }    if (!empty($uloz['id'])) { //Ulozenie v poriadku      $this->flashRedirect('User:', 'Údaje boli uložené!', 'success');    } else {									//Ulozenie sa nepodarilo      $this->flashMessage('Došlo k chybe a údaje sa neuložili. Skúste neskôr znovu...', 'danger');    }  }  /** Filtre pre sablonu   * @param type $class   * @return type   */	protected function createTemplate($class = NULL) {    $template = parent::createTemplate($class);    //Helper clenclass - vyber classu podla poctu prihlaseni    $template->addFilter('clenclass', function ($pocet, $max) {    	$pok=100*$pocet/$max;      return "vyb".($pok>70 ? 1 : ($pok>45 ? 2 : ($pok>30 ? 3 : ($pok>0 ? 4 : 5))));    });    return $template;	}      /** Funkcia pre spracovanie signálu vymazavania	  * @param int $id - id polozky v hlavnom menu		* @param string $nazov - nazov polozky z hl. menu - na zrusenie?		* @param string $druh - blizsia specifikacia, kde je to potrebne		*/	function confirmedDelete($id, $nazov, $druh = "")	{    if ($druh === "admin") {       $path = $this->context->parameters["wwwDir"] . "/www/files/".$id;      if (is_dir($path)) { //Vymazanie adresaru s avatarom        foreach (glob("$path*.{jpg,jpeg,gif,png}", GLOB_BRACE) as $file) {          @unlink($file);        }        rmdir($path);      }      $clen =$this->user_profiles->find($id);      $clen_id_users = $clen->id_users;      $meno = $clen->meno." ".$clen->priezvisko;      try {        $this->user_profiles->oprav($id, ['id_users'=>1]);        $this->users->zmaz($clen_id_users);        $this->user_profiles->zmaz($id);        $this->flashMessage('Užívateľ '.$meno.' bol zmazaný!', 'success');      } catch (Exception $e) {        $this->flashMessage('Došlo k chybe pri vymazávaní. Skúste neskôr znovu...'.$e->getMessage(), 'danger');      }      if (!$this->isAjax()) { $this->redirect('User:'); }    }  }    /** Spolocna obluha formularov pri stornovani formulara */	public function formCancelled() {		$this->redirect('User:');	}}